---
title: "Tree Simulation"
author: "jhmarcus"
date: "2019-04-03"
output: workflowr::wflow_html
---

Here I analze simulated genotype data from a tree. See [Pickrell et al. 2012 Figure 2](https://journals.plos.org/plosgenetics/article?id=10.1371/journal.pgen.1002967) for details on the the demographic model used.

# Imports

Lets import some needed packages:

```{r imports, warning=FALSE, message=FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)
library(RColorBrewer)
library(biomaRt)
library(knitr)
source("../code/viz.R")
```

# FLASH-Greedy

Lets first read the greedy `flashier` fit

```{r flash-greedy}
# read the flash fit output by snakemake
flash_fit = readRDS("../output/flash_greedy/tree_sim/tree_sim_maf_ldprune.rds")

# read the snp meta data
bim_df = read.table("../data/datasets/tree_sim/tree_sim_maf_ldprune.bim", header=F)
colnames(bim_df) = c("chrom", "rsid", "cm", "pos", "a1", "a2")

# drift event loadings lfsr
l_lfsr_df = data.frame(flash_fit$lfsr[[1]])
colnames(l_lfsr_df) = 1:21

# drift event lfsr
delta_lfsr_df = data.frame(flash_fit$lfsr[[2]])
colnames(delta_lfsr_df) = 1:21
delta_lfsr_df$chrom = bim_df$chrom
delta_lfsr_df$pos = bim_df$pos
delta_lfsr_df$rsid = bim_df$rsid

# drift events
delta_df = as.data.frame(flash_fit$loadings$normalized.loadings[[2]])
colnames(delta_df) = 1:21
delta_df$chrom = bim_df$chrom
delta_df$pos = bim_df$pos
delta_df$rsid = bim_df$rsid

# number of drift events
K = ncol(flash_fit$loadings$normalized.loadings[[1]]) 

# number of individuals
n = nrow(flash_fit$loadings$normalized.loadings[[1]])

# number of SNPs
p = nrow(flash_fit$loadings$normalized.loadings[[2]])
print(K)
print(n)
print(p)
```

# PVEs
 
Here is a plot of the proportion of variance (PVE) explained by each drift event:

```{r flash-greedy-ld-viz-pve, warning=FALSE, message=FALSE}
p_pve = qplot(2:K, flash_fit$pve[2:K]) + 
        ylab("Proportion of Varaince Explained") + 
        xlab("K") + 
        theme_bw()
p_pve
print(flash_fit$pve)
```

It's quite odd the that pves are wiggly. I don't think I understand why that would be the case.

# Fitted Mean and Variance

I setup the `flashier` run so it estimates a SNP specific precision term. Here is a histogram of fitted variances:

```{r flash-greedy-viz-var, warning=FALSE, message=FALSE}
p_var = qplot(1/flash_fit$fit$est.tau) + 
        xlab("Estimated Variance") + 
        ylab("Count") + 
        theme_bw()
p_var
```

Lets now look the the fitted means:

```{r flash-greedy-viz-mean, warning=FALSE, message=FALSE}
mu = sqrt(flash_fit$loadings$scale.constant[1]) * delta_df$`1`
p_mu = qplot(mu) + 
       xlab("Estimated Mean") + 
       ylab("Count") + 
       theme_bw()
p_mu
```

It looks like many of the SNPs are on the rarer side. We should see a quadratic relationship with the estimated variance:

```{r flash-greedy-viz-mv, warning=FALSE, message=FALSE}
d1 = flash_fit$loadings$scale.constant[1]
mv_df = data.frame(var=1/flash_fit$fit$est.tau, mu=mu, chrom=bim_df$chrom)
p_mv = ggplot(mv_df, aes(x=mu, y=var)) + 
       geom_point() + 
       xlab("Estimated Mean") + ylab("Estimated Variance") + 
       scale_alpha(guide = "none") + 
       stat_function(fun = function(x){return(2*x*(1-x))}, color="red") + 
       xlim(0, .5) + 
       theme_bw()

p_mv
```

```{r flash-viz-loadings, warning=FALSE, message=FALSE}
# setup loadings data.frame
l_df = as.data.frame(flash_fit$loadings$normalized.loadings[[1]])
l_df$iid = 1:200
l_df$clst = c(rep("pop1", 10), 
              rep("pop2", 10), 
              rep("pop3", 10), 
              rep("pop4", 10), 
              rep("pop5", 10), 
              rep("pop6", 10), 
              rep("pop7", 10), 
              rep("pop8", 10), 
              rep("pop9", 10), 
              rep("pop10", 10), 
              rep("pop11", 10), 
              rep("pop12", 10), 
              rep("pop13", 10), 
              rep("pop14", 10), 
              rep("pop15", 10), 
              rep("pop16", 10), 
              rep("pop17", 10), 
              rep("pop18", 10), 
              rep("pop19", 10), 
              rep("pop20", 10))
colnames(l_df)[1:21] = 1:21
pops = paste0("pop", 1:20)

# gather the data.frame for plotting
gath_df = l_df %>%
          select_if(~sum(!is.na(.)) > 0) %>%
          gather(K, value, -iid, -clst) %>% 
          filter(K %in% paste0(2:2)) 

p = ggplot(data=gath_df, aes(x=reorder(iid, desc(value)), y=value, fill=factor(K))) + 
      geom_bar(stat="identity", width=1) +  
      scale_fill_brewer(palette = "Set3") + 
      scale_y_continuous(expand=c(0, 0)) +
      scale_x_discrete(expand=c(0, 0)) +
      facet_grid(. ~ factor(clst, levels=pops), scales = "free", space="free", switch="both") + 
      theme_classic() +
      theme(panel.spacing = unit(0.2, "lines"), 
            strip.background = element_rect(colour="white", fill="white"),
            strip.text.x = element_text(colour = "black", angle = 90, hjust = 1.1), 
            strip.placement = "outside", 
            panel.grid.major = element_blank(), 
            panel.grid.minor = element_blank(),
            axis.text.x=element_blank(), 
            axis.ticks.x=element_blank()) + 
            ylab("") + 
            xlab("") 
p
```